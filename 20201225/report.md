# SQLインジェクション攻撃

# SQLインジェクション攻撃とは何か?

### SQLインジェクションとは？

不正な「SQL」命令を攻撃対象のサイトに「注入する（インジェクションする）」こと

### よって...

攻撃者は好きなSQL文を他人のデータベースで動かすことができてしまう！

### だから...

- 不正ログインし放題！

    「ID」と「パスワード」を知らなくてもログインできてしまう可能性がある → 後述

- 顧客のデータが危うい！

    `SELECT * FROM USER_TABLE;` とかされるとすべての顧客データが抜かれたりする。

    `DROP TABLE USER_TABLE;` とかされたら顧客データを全消しされたりする。

### どうやって？

「ID」欄に以下の文字列を入力してログインする。

```sql
1' or '1' = '1';--
```

たったこれだけでログインできてしまう！

### なぜ？

前提として以下のSQL文が使われているとする。

```sql
SELECT id,pass FROM login_user WHERE id='入力されたID' AND pass='入力されたパスワード';
```

すると、さっきのIDをSQLに入れると・・・

```sql
SELECT id,pass FROM login_user WHERE id='1' or '1' = '1'-- AND pass='';
```

idの条件が"1"または"1 = 1"という条件なので必ずtrueになる。

そして残りはコメントアウトなので無視され、必ずログインできる文になってしまう。

また、セミコロン「;」を使うことでSQLを複数のSQL文を連結させることができるので、複数のクエリを実行して更に悪さを行うことができる。

### 安全なウェブサイトの作り方は？

フォームなどに不正な値を入れられないように、記号を制限したり、文字数を制限するなどの検証コードを入れ、チェックしよう。

### 安全なSQLの呼び出し方

1. サニタイズと呼ばれる無害化処理を行うことでSQLに混ぜても大丈夫なコードに変換する。
2. プリペアドステートメントと呼ばれる変数をプログラム的に注入できる関数を使ってSQLを呼び出す → 後述

# 攻撃を防ぐためにはどうすべきか？

文字列連結でSQL文を作るからまずい事が起こる。

→ ユーザーから入力される文字列をSQLに混ぜては行けない。

これは、JavaScriptのクロスサイトスクリプティングや、eval系の処理を行うすべてのプログラムに言えること。

なので、プリペアドステートメントってのを使ってインジェクションを対策してみよう。

### プリペアドステートメントってなに？

変数を直接連結するのは危険なので、?という文字に一旦置き換え、プログラムで後から入れることができる仕組みだ。

### 具体的なSQLの記述方法、PHPのコード

まずはコードを見てみよう。

これを

```sql
SELECT id,pass FROM login_user WHERE id='入力されたID' AND pass='入力されたパスワード';
```

こうする

```php
$stmt = $db->prepare("SELECT * FROM users WHERE email = ? AND password = ?");
$stmt->execute($_POST['email'], $_POST['password']);
```

idやpassという変数の部分を一旦 `?` という記号でおき、あとからexecuteに渡すという手法だ。

こうすれば洗練されたライブラリがいい感じに無害化してくれるため、安全である。

## 出典

- 安全なウェブサイトの作り方

    [安全なウェブサイトの作り方：IPA 独立行政法人 情報処理推進機構](https://www.ipa.go.jp/security/vuln/websecurity.html)

- 【初心者向け】SQLインジェクションの概要と対策方法

    [【初心者向け】SQLインジェクションの概要と対策方法 | カゴヤのサーバー研究室](https://www.kagoya.jp/howto/network/sql-injection/)

- SQLインジェクションとは | 具体的な攻撃例と対策方法

    [SQLインジェクションとは | 具体的な攻撃例と対策方法](https://medium-company.com/sql%E3%82%A4%E3%83%B3%E3%82%B8%E3%82%A7%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3/)